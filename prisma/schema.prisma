// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id            String         @id @default(cuid())
  email         String         @unique
  name          String?
  password      String
  emailVerified DateTime?
  image         String?
  roleId        String?
  role          Role?          @relation(fields: [roleId], references: [id], onDelete: SetNull)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  deletedAt     DateTime?
  refreshTokens RefreshToken[]
  uploadedMedia Media[]
  mediaFolders  MediaFolder[]
  auditLogs     AuditLog[]
  
  // Course relations
  instructorCourses  Course[]            @relation("InstructorCourses")
  enrollments        Enrollment[]
  reviews            Review[]
  transactions       Transaction[]
  instructorEarnings InstructorEarning[] @relation("InstructorEarnings")

  @@index([email])
  @@index([roleId])
  @@index([deletedAt])
}

model RefreshToken {
  id        String    @id @default(cuid())
  token     String    @unique
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
}

model Role {
  id              String           @id @default(cuid())
  name            String           @unique
  description     String?
  isSystem        Boolean          @default(false)
  users           User[]
  rolePermissions RolePermission[]
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  deletedAt       DateTime?

  @@index([deletedAt])
}

model Permission {
  id              String           @id @default(cuid())
  code            String           @unique
  description     String?
  rolePermissions RolePermission[]
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  deletedAt       DateTime?

  @@index([deletedAt])
}

model RolePermission {
  id           String     @id @default(cuid())
  roleId       String
  permissionId String
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  deletedAt    DateTime?

  @@unique([roleId, permissionId])
  @@index([roleId])
  @@index([permissionId])
  @@index([deletedAt])
}

model MediaFolder {
  id        String        @id @default(cuid())
  name      String
  parentId  String?
  parent    MediaFolder?  @relation("FolderHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children  MediaFolder[] @relation("FolderHierarchy")
  media     Media[]
  createdBy String
  creator   User          @relation(fields: [createdBy], references: [id], onDelete: Cascade)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  deletedAt DateTime?

  @@index([parentId])
  @@index([createdBy])
  @@index([deletedAt])
}

model Media {
  id              String       @id @default(cuid())
  filename        String
  originalName    String
  mimeType        String
  size            Int
  width           Int?
  height          Int?
  duration        Int?
  path            String
  url             String
  thumbnailUrl    String?
  publicId        String? // Cloudinary public ID for deletion
  storageProvider String       @default("local") // "local" or "cloudinary"
  alt             String?
  title           String?
  description     String?
  folderId        String?
  folder          MediaFolder? @relation(fields: [folderId], references: [id], onDelete: SetNull)
  uploadedBy      String
  uploader        User         @relation(fields: [uploadedBy], references: [id], onDelete: Cascade)
  usageCount      Int          @default(0)
  mediaUsages     MediaUsage[]
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  deletedAt       DateTime?

  @@index([folderId])
  @@index([storageProvider])
  @@index([uploadedBy])
  @@index([mimeType])
  @@index([deletedAt])
  @@index([createdAt])
}

model MediaUsage {
  id         String    @id @default(cuid())
  mediaId    String
  media      Media     @relation(fields: [mediaId], references: [id], onDelete: Cascade)
  entityType String
  entityId   String
  fieldName  String?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  deletedAt  DateTime?

  @@unique([mediaId, entityType, entityId, fieldName])
  @@index([mediaId])
  @@index([entityType, entityId])
  @@index([deletedAt])
}

model AuditLog {
  id         String   @id @default(cuid())
  userId     String?
  user       User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  action     String
  entityType String
  entityId   String?
  entityName String?
  changes    Json?
  metadata   Json?
  ipAddress  String?
  userAgent  String?
  status     String   @default("success")
  errorMsg   String?
  createdAt  DateTime @default(now())

  @@index([userId])
  @@index([action])
  @@index([entityType])
  @@index([entityId])
  @@index([createdAt])
  @@index([status])
}

model Setting {
  id          String   @id @default(cuid())
  key         String   @unique
  value       Json
  group       String // general, email, media, security, notification, seo, localization, backup
  type        String // string, number, boolean, json, array
  label       String? // Display label
  description String? // Help text
  isPublic    Boolean  @default(false) // Can be accessed without auth
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([group])
  @@index([key])
  @@index([isPublic])
}

model LoginAttempt {
  id        String   @id @default(cuid())
  email     String
  ipAddress String?
  success   Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([email])
  @@index([ipAddress])
  @@index([createdAt])
  @@index([email, createdAt])
}

model Backup {
  id              String   @id @default(cuid())
  filename        String
  filePath        String? // Path to backup file on server
  size            Int // Size in bytes
  type            String // manual, scheduled
  status          String   @default("pending") // pending, completed, failed
  includeDatabase Boolean  @default(true)
  includeMedia    Boolean  @default(false)
  includeSettings Boolean  @default(true)
  data            Json? // Backup data stored as JSON (legacy, now stored in file)
  errorMessage    String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([type])
  @@index([status])
  @@index([createdAt])
}

model EmailTemplate {
  id          String    @id @default(cuid())
  slug        String    @unique // e.g., welcome, reset-password, order-confirm
  name        String // Display name
  subject     String // Email subject with variable support
  body        String    @db.Text // Email body content (HTML/Markdown)
  bodyType    String    @default("html") // html or markdown
  description String? // Help text about when this template is used
  variables   Json? // Available variables: [{ key: "name", description: "User's name" }]
  isSystem    Boolean   @default(false) // System templates cannot be deleted
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?

  @@index([slug])
  @@index([isActive])
  @@index([deletedAt])
}

enum VerificationType {
  EMAIL_VERIFY
  PASSWORD_RESET
}

model VerificationCode {
  id          String           @id @default(cuid())
  email       String // Email address (can be used before user exists)
  code        String // 6-digit code
  type        VerificationType
  attempts    Int              @default(0) // Track failed attempts
  maxAttempts Int              @default(5) // Max allowed attempts
  expiresAt   DateTime // Code expiration time
  usedAt      DateTime? // When the code was successfully used
  createdAt   DateTime         @default(now())

  @@index([email, type])
  @@index([code])
  @@index([expiresAt])
}

// ==================== COURSE MANAGEMENT ====================

model Category {
  id          String     @id @default(cuid())
  name        String
  slug        String     @unique
  description String?
  image       String?
  parentId    String?
  parent      Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children    Category[] @relation("CategoryHierarchy")
  courses     Course[]
  sortOrder   Int        @default(0)
  isActive    Boolean    @default(true)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  deletedAt   DateTime?

  @@index([parentId])
  @@index([slug])
  @@index([isActive])
  @@index([deletedAt])
}

enum CourseLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
  ALL_LEVELS
}

enum CourseStatus {
  DRAFT
  PENDING_REVIEW
  PUBLISHED
  REJECTED
  ARCHIVED
}

model Course {
  id              String       @id @default(cuid())
  title           String
  slug            String       @unique
  shortDescription String?     @db.VarChar(500)
  description     String?      @db.Text
  thumbnail       String?
  previewVideo    String?
  price           Decimal      @default(0) @db.Decimal(10, 2)
  salePrice       Decimal?     @db.Decimal(10, 2)
  currency        String       @default("VND")
  level           CourseLevel  @default(ALL_LEVELS)
  status          CourseStatus @default(DRAFT)
  language        String       @default("vi")
  requirements    String[]     @default([])
  objectives      String[]     @default([]) // What students will learn
  targetAudience  String[]     @default([]) // Who is this course for
  
  // Instructor
  instructorId    String
  instructor      User         @relation("InstructorCourses", fields: [instructorId], references: [id], onDelete: Cascade)
  
  // Category
  categoryId      String?
  category        Category?    @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  
  // Stats
  totalDuration   Int          @default(0) // Total duration in seconds
  totalLessons    Int          @default(0)
  totalSections   Int          @default(0)
  enrollmentCount Int          @default(0)
  rating          Decimal      @default(0) @db.Decimal(2, 1)
  reviewCount     Int          @default(0)
  
  // Dates
  publishedAt     DateTime?
  approvedAt      DateTime?
  approvedBy      String?
  rejectedAt      DateTime?
  rejectedBy      String?
  rejectionReason String?
  
  // Relations
  sections        Section[]
  enrollments     Enrollment[]
  reviews         Review[]
  
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  deletedAt       DateTime?

  @@index([instructorId])
  @@index([categoryId])
  @@index([status])
  @@index([slug])
  @@index([publishedAt])
  @@index([deletedAt])
}

model Section {
  id          String    @id @default(cuid())
  title       String
  description String?
  courseId    String
  course      Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)
  sortOrder   Int       @default(0)
  lessons     Lesson[]
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?

  @@index([courseId])
  @@index([sortOrder])
  @@index([deletedAt])
}

enum LessonType {
  VIDEO
  TEXT
  QUIZ
  ASSIGNMENT
  LIVE
}

model Lesson {
  id            String     @id @default(cuid())
  title         String
  description   String?    @db.Text
  type          LessonType @default(VIDEO)
  
  // Video
  videoUrl      String?
  videoDuration Int        @default(0) // Duration in seconds
  videoProvider String?    // local, youtube, vimeo, etc.
  
  // Content
  content       String?    @db.Text // For TEXT type lessons
  
  // Settings
  isFree        Boolean    @default(false) // Free preview
  isPublished   Boolean    @default(false)
  sortOrder     Int        @default(0)
  
  // Section
  sectionId     String
  section       Section    @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  
  // Progress tracking
  progress      LessonProgress[]
  
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  deletedAt     DateTime?

  @@index([sectionId])
  @@index([type])
  @@index([isPublished])
  @@index([sortOrder])
  @@index([deletedAt])
}

enum EnrollmentStatus {
  ACTIVE
  COMPLETED
  EXPIRED
  REFUNDED
}

model Enrollment {
  id              String           @id @default(cuid())
  userId          String
  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  courseId        String
  course          Course           @relation(fields: [courseId], references: [id], onDelete: Cascade)
  
  status          EnrollmentStatus @default(ACTIVE)
  progress        Int              @default(0) // 0-100 percentage
  completedAt     DateTime?
  
  // Payment info
  pricePaid       Decimal          @default(0) @db.Decimal(10, 2)
  currency        String           @default("VND")
  transactionId   String?
  
  // Progress tracking
  lessonProgress  LessonProgress[]
  
  enrolledAt      DateTime         @default(now())
  expiresAt       DateTime?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  deletedAt       DateTime?

  @@unique([userId, courseId])
  @@index([userId])
  @@index([courseId])
  @@index([status])
  @@index([enrolledAt])
  @@index([deletedAt])
}

model LessonProgress {
  id           String     @id @default(cuid())
  enrollmentId String
  enrollment   Enrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  lessonId     String
  lesson       Lesson     @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  
  isCompleted  Boolean    @default(false)
  watchedTime  Int        @default(0) // Seconds watched
  completedAt  DateTime?
  
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  @@unique([enrollmentId, lessonId])
  @@index([enrollmentId])
  @@index([lessonId])
  @@index([isCompleted])
}

model Review {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  courseId  String
  course    Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  
  rating    Int      // 1-5
  title     String?
  content   String?  @db.Text
  
  isVisible Boolean  @default(true)
  isEdited  Boolean  @default(false)
  
  // Instructor response
  response  String?  @db.Text
  respondedAt DateTime?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?

  @@unique([userId, courseId])
  @@index([courseId])
  @@index([userId])
  @@index([rating])
  @@index([isVisible])
  @@index([deletedAt])
}

enum TransactionType {
  ENROLLMENT    // User pays for course
  PAYOUT        // Platform pays instructor
  REFUND        // Refund to user
  COMMISSION    // Platform commission
}

enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
  CANCELLED
}

model Transaction {
  id              String            @id @default(cuid())
  type            TransactionType
  status          TransactionStatus @default(PENDING)
  
  amount          Decimal           @db.Decimal(10, 2)
  currency        String            @default("VND")
  
  // User who made the payment (for ENROLLMENT) or receives (for PAYOUT)
  userId          String
  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Related course
  courseId        String?
  
  // Instructor who receives payment
  instructorId    String?
  
  // Payment details
  paymentMethod   String?           // vnpay, momo, bank_transfer, etc.
  paymentRef      String?           // External reference
  
  // Commission
  platformFee     Decimal?          @db.Decimal(10, 2)
  instructorAmount Decimal?         @db.Decimal(10, 2)
  
  note            String?
  metadata        Json?
  
  processedAt     DateTime?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  @@index([userId])
  @@index([instructorId])
  @@index([courseId])
  @@index([type])
  @@index([status])
  @@index([createdAt])
}

model InstructorEarning {
  id              String   @id @default(cuid())
  instructorId    String
  instructor      User     @relation("InstructorEarnings", fields: [instructorId], references: [id], onDelete: Cascade)
  
  // Period
  month           Int      // 1-12
  year            Int
  
  // Amounts
  totalRevenue    Decimal  @default(0) @db.Decimal(12, 2) // Gross revenue
  platformFee     Decimal  @default(0) @db.Decimal(12, 2) // Platform commission
  netEarnings     Decimal  @default(0) @db.Decimal(12, 2) // Net after fee
  
  // Stats
  enrollmentCount Int      @default(0)
  refundCount     Int      @default(0)
  refundAmount    Decimal  @default(0) @db.Decimal(12, 2)
  
  // Payout
  isPaidOut       Boolean  @default(false)
  paidOutAt       DateTime?
  payoutRef       String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([instructorId, month, year])
  @@index([instructorId])
  @@index([year, month])
  @@index([isPaidOut])
}
